<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>plot data</title>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link href="css/ip.grid.css" rel="stylesheet">
        <link href="css/magic-check.css" rel="stylesheet">


		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="js/jquery-ui-1.9.2.custom.min.js"></script>
        <script src="js/ip.grid.js"></script>

        <script>
            $(document).ready(function () {
                $('#demo').ip_Grid({ rows: 10000,  cols: 26 ,showGridResizerX: false});
                $('#demo').disableSelection();
            });
        </script>

        <style>
            body {
                background-color: #696969;
            }

            .right{
                float: right;
                width:50%;
            }

            .float_right{
                float: right;
                padding:5px;
            }

            .float_left{
                float: left;
                padding:5px;
            }

            .left{
                float: left;
                width:50%;
                height:100vh;
            }

            .css_figure{
                float: left;
                height: 50vh;
                width: 100%;
            }

            #demo {
                width:100%;
                height:100%;
            }
        </style>

    </head>
    <body>
        <div id="sheet" class="left">
            <div id="demo"></div>
        </div>
        <div class="right">
            <button class="btn btn-primary float_right" id="sav_data">download sheet</button>
            <button class="btn btn-primary" id="draw">draw</button>
            <button class="btn btn-primary" id="clear">clear all</button>
            <div id="figures"></div>
        </div>

        <script>
            var fig_cnt = 0;
            $(window).on("resize",function(){
                $('#demo').ip_ResizeGrid({width: $("#sheet").width()});
            });

            $("#clear").click(function(){
                $("#figures").empty();
                fig_cnt = 0;
            });

            $(document).on("click","button",function(){
                if(this.id.indexOf("fig")>-1){
                    $("#"+this.id+"_div").remove();
                }
            });

            $(document).on("dblclick","div",function(){
                //if(this.id == "fig1_fig"){
                    console.log(this.id);
                //}

            });

            $(document).on('change', '[type=checkbox]', function() {
                let ck_id = this.id;
                let parts = ck_id.split("_ck_");

                if(parts[1] == "leg"){
                    let ck_status = $("#"+ck_id).prop("checked");
                    let update = {showlegend: ck_status};
                    Plotly.relayout(parts[0]+"_fig", update);
                }
                if(parts[1] == "dot"){
                    let ck_status_dot = $("#"+ck_id).prop("checked");
                    let ck_status_line = $("#"+parts[0]+"_ck_line").prop("checked");
                    if(ck_status_line){
                        let plot_mode;
                        if(ck_status_dot){
                            plot_mode = "lines + markers";
                            $("#"+parts[0]+"_ck_line").attr("disabled", false);
                        }
                        else{
                            plot_mode = "lines";
                            $("#"+parts[0]+"_ck_line").attr("disabled", true);
                        }
                        let update = {mode: plot_mode};
                        Plotly.restyle(parts[0]+"_fig", update);
                    }
                }
                if(parts[1] == "line"){
                    let ck_status_line = $("#"+ck_id).prop("checked");
                    let ck_status_dot = $("#"+parts[0]+"_ck_dot").prop("checked");
                    if(ck_status_dot){
                        let plot_mode;
                        if(ck_status_line){
                            plot_mode = "lines + markers";
                            $("#"+parts[0]+"_ck_dot").attr("disabled", false);
                        }
                        else{
                            plot_mode = "markers";
                            $("#"+parts[0]+"_ck_dot").attr("disabled", true);
                        }
                        let update = {mode: plot_mode};
                        Plotly.restyle(parts[0]+"_fig", update);
                    }
                }

            });

            $(window).bind("paste", function(e){
                $('#demo').ip_PasteFromClipboard(e);
            });

            $("#sav_data").click(function(){
                var data_to_save = [];
                let csvContent = "data:text/csv;charset=utf-8,";
                for(let i=0;i<10000;i++){
                    data_to_save.push([]);
                    for(let j=0;j<26;j++){
                        data_to_save[i].push($('#demo').ip_GetElementValue(i,j));
                    }
                }
                data_to_save.forEach(function(rowArray){
                    let row = rowArray.join(",");
                    csvContent += row + "\r\n"; // add carriage return
                });

                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "table.csv");
                document.body.appendChild(link); // Required for FF
                link.click(); // This will download the data file named "my_data.csv".
            });

            $("#draw").click(function(){
                let ranges = $('#demo').ip_GetRange();
                if(ranges.length==0){
                    return;
                }
                fig_cnt++;
                let minrc = [ranges[0][0][0],ranges[0][0][1]];
                let maxrc = [ranges[0][1][0],ranges[0][1][1]];
                for(let i = 1; i<ranges.length; i++){
                    if(minrc[1]>ranges[i][0][1]){
                        minrc[0] = ranges[i][0][0];
                        minrc[1] = ranges[i][0][1];
                    }
                    else if(minrc[1]==ranges[i][0][1] && minrc[0]>ranges[i][0][0]){
                        if(maxrc[0]<ranges[i][1][0]){
                            maxrc[0] = ranges[i][1][0];
                        }
                    }
                    if(maxrc[1]<ranges[i][1][1]){
                        maxrc[1] = ranges[i][1][1];
                    }
                }
                minrc[0] = Math.max(0,minrc[0]);
                minrc[1] = Math.max(0,minrc[1]);

                let data_T = [];
                for(let i = minrc[1]; i<=maxrc[1]; i++){
                    data_T.push([]);
                }

                for(let i = 0; i<ranges.length; i++){
                    for(let k=ranges[i][0][1];k<=ranges[i][1][1];k++){
                        for(let j=ranges[i][0][0];j<=ranges[i][1][0];j++){
                            if(k>=minrc[1]&&k<=maxrc[1]&&j>=minrc[0]&&j<=maxrc[0]){
                                let one_element = $('#demo').ip_GetElementValue(j,k);
                                data_T[k-minrc[1]][j-minrc[0]] = one_element;
                            }
                        }
                    }
                }
                Plot(data_T,fig_cnt.toString());
            });

            function Plot(data_T, fig_id){
                let data = [];
                if(data_T.length==1){
                    let x = Array.from(new Array(data_T[0].length), (val, index) => index + 1);
                    data_T.unshift(x);
                }

                data_count = 0;
                for(let i = 1;i<data_T.length;i++){
                    let x_tmp = data_T[0];
                    let y_tmp = data_T[i];
                    let data_flt = [[],[]];
                    let data_name = "";
                    for(let j = 0;j<x_tmp.length;j++){
                        let xx = x_tmp[j];
                        let yy = y_tmp[j];
                        if(!isNaN(xx) && !isNaN(yy) && !(xx===null) && !(yy===null)){
                            data_flt[0].push(Number(xx));
                            data_flt[1].push(Number(yy));
                        }
                        else if(isNaN(xx) && isNaN(yy) && xx!==undefined && yy!==undefined && j==0){
                            data_name = yy;
                        }
                    }

                    if(data_flt[1].length>0){
                        if(data_name.length==0){
                            data_count++;
                            data_name = "data"+data_count.toString();
                        }
                        data.push({
                            name: data_name,
                            x: data_flt[0],
                            y: data_flt[1],
                            mode: 'lines + markers',
                        });
                    }
                }

                let layout ={
                    //paper_bgcolor: 'rgb(150,150,150)',
                    title: "fig. " + fig_id,
                    showlegend: false,
                    xaxis: {
                        zeroline: false,
                        linecolor: 'black',
                        mirror: true,
                        //type: 'log',
                        autorange: true
                    },
                    yaxis: {
                        zeroline: false,
                        linecolor: 'black',
                        mirror: true,
                        //title: 'Magnitude (dB)',
                        autorange: true
                    },
                };

                $("<div/>", {
                    id: "fig"+ fig_id + "_div",
                }).appendTo("#figures");
                $("<div/>", {
                    id: "fig"+ fig_id + "_div_main",
                }).appendTo("#fig"+fig_id+"_div");
                $("<div/>", {
                    id: "fig"+ fig_id + "_div_sub",
                }).appendTo("#fig"+fig_id+"_div");

                $("<div/>", {
                    id: "fig"+ fig_id + "_fig",
                    class: "css_figure"
                }).appendTo("#fig"+fig_id+"_div_main");

                $("<div/>", {
                    id: "fig"+ fig_id + "_div_sub0",
                    style: "background-color:#fff;",
                    class: "float_right"
                }).appendTo("#fig"+fig_id+"_div_sub");
                $("<button/>", {
                    id: "fig"+ fig_id,
                    class: "btn btn-danger",
                    text: "remove fig." + fig_id
                }).appendTo("#fig"+fig_id+"_div_sub0");

                $("<div/>", {
                    id: "fig"+ fig_id + "_div_sub1",
                    style: "background-color:#fff;",
                    class: "float_left"
                }).appendTo("#fig"+fig_id+"_div_sub");
                $("<input/>", {
                    type: "checkbox",
                    class: "magic-checkbox",
                    id: "fig"+ fig_id+"_ck_leg",
                }).appendTo("#fig"+fig_id+"_div_sub1");
                $("<label/>", {
                    for: "fig"+ fig_id+"_ck_leg",
                    text: "legend"
                }).appendTo("#fig"+fig_id+"_div_sub1");

                $("<div/>", {
                    id: "fig"+ fig_id + "_div_sub2",
                    style: "background-color:#fff;",
                    class: "float_left"
                }).appendTo("#fig"+fig_id+"_div_sub");
                $("<input/>", {
                    type: "checkbox",
                    class: "magic-checkbox",
                    checked: "isChecked",
                    id: "fig"+ fig_id+"_ck_dot",
                }).appendTo("#fig"+fig_id+"_div_sub2");
                $("<label/>", {
                    for: "fig"+ fig_id+"_ck_dot",
                    text: "dot style"
                }).appendTo("#fig"+fig_id+"_div_sub2");

                $("<div/>", {
                    id: "fig"+ fig_id + "_div_sub3",
                    style: "background-color:#fff;",
                    class: "float_left"
                }).appendTo("#fig"+fig_id+"_div_sub");
                $("<input/>", {
                    type: "checkbox",
                    class: "magic-checkbox",
                    checked: "isChecked",
                    id: "fig"+ fig_id+"_ck_line",
                }).appendTo("#fig"+fig_id+"_div_sub3");
                $("<label/>", {
                    for: "fig"+ fig_id+"_ck_line",
                    text: "line style"
                }).appendTo("#fig"+fig_id+"_div_sub3");


                Plotly.newPlot("fig"+fig_id+"_fig", data, layout);
            }
        </script>
    </body>
</html>
